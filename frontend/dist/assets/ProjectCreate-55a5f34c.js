import{_ as B,W as I,y as u,C as L,z,c as b,b as g,d as e,w as o,a as N,B as P,E as Y,r,o as m,e as R,H as E,g as A,F as q,A as H,t as F,x as J}from"./index-9a8ac2de.js";import{F as O}from"./FileUpload-c7558ec6.js";const T={name:"ProjectCreate",components:{FileUpload:O,Loading:I},setup(){const U=N(),l=u(null),j=u(!1),t=u(!1),V=u([]),w=u([]),_=L({name:"",description:"",status:"进行中",priority:"中",start_date:"",end_date:""}),x=u(null),i=u([]),s=async()=>{j.value=!0;try{const n=await P.get("/api/v1/users");V.value=n.data.filter(d=>d.id!==c())}catch(n){console.error("加载用户列表失败:",n),Y.error("加载用户列表失败，将使用空列表"),V.value=[]}finally{j.value=!1}},c=()=>{const n=localStorage.getItem("user");if(n)try{return JSON.parse(n).id}catch{return null}return null},h=n=>{i.value.push(n)},f=n=>{const d=i.value.findIndex(p=>p.file_path===n.file_path);d!==-1&&i.value.splice(d,1)},D=async()=>{var n,d;t.value=!0;try{const p=w.value.map(y=>({user_id:y,role:"成员"})),M={..._,members:p},k=await P.post("/api/v1/projects",M);if(i.value.length>0){const y=k.data.id,C=localStorage.getItem("token");for(const v of i.value)try{await P.post(`/api/v1/projects/${y}/files`,{file_path:v.file_path,original_name:v.original_name,file_size:v.file_size,file_type:v.file_type},{headers:{Authorization:`Bearer ${C}`}})}catch(a){console.error("关联文件到项目失败:",a)}}Y.success("项目创建成功"),U.push({name:"ProjectDetail",params:{id:k.data.id}})}catch(p){console.error("创建项目失败:",p),Y.error(((d=(n=p.response)==null?void 0:n.data)==null?void 0:d.message)||"创建项目失败")}finally{t.value=!1}};return z(()=>{s()}),{projectForm:l,projectData:_,loading:j,creating:t,users:V,selectedMembers:w,fileUploadRef:x,projectFiles:i,handleFileUploaded:h,handleFileRemoved:f,createProject:D}}},W={class:"project-create"},G={class:"page-header"},K={key:0,class:"loading-container"},Q={key:2,class:"member-list"},X={class:"member-name"},Z={class:"member-email"},$={class:"selected-count"},ee={key:0,class:"file-list-info mt-2"};function te(U,l,j,t,V,w){const _=r("el-button"),x=r("router-link"),i=r("el-input"),s=r("el-form-item"),c=r("el-option"),h=r("el-select"),f=r("el-col"),D=r("el-row"),n=r("el-date-picker"),d=r("Loading"),p=r("el-icon"),M=r("el-empty"),k=r("el-checkbox"),y=r("file-upload"),C=r("el-form"),v=r("el-card");return m(),b("div",W,[g("div",G,[l[9]||(l[9]=g("h2",{class:"page-title"},"创建新项目",-1)),e(x,{to:{name:"ProjectList"}},{default:o(()=>[e(_,null,{default:o(()=>l[8]||(l[8]=[R("返回")])),_:1})]),_:1})]),e(v,null,{default:o(()=>[e(C,{ref:"projectForm",model:t.projectData,"label-width":"100px",onSubmit:E(t.createProject,["prevent"])},{default:o(()=>[e(s,{label:"项目名称",prop:"name"},{default:o(()=>[e(i,{modelValue:t.projectData.name,"onUpdate:modelValue":l[0]||(l[0]=a=>t.projectData.name=a),placeholder:"输入项目名称",required:""},null,8,["modelValue"])]),_:1}),e(s,{label:"项目描述",prop:"description"},{default:o(()=>[e(i,{modelValue:t.projectData.description,"onUpdate:modelValue":l[1]||(l[1]=a=>t.projectData.description=a),type:"textarea",rows:5,placeholder:"输入项目描述"},null,8,["modelValue"])]),_:1}),e(D,{gutter:20},{default:o(()=>[e(f,{span:12},{default:o(()=>[e(s,{label:"项目状态",prop:"status"},{default:o(()=>[e(h,{modelValue:t.projectData.status,"onUpdate:modelValue":l[2]||(l[2]=a=>t.projectData.status=a),placeholder:"选择项目状态",style:{width:"100%"}},{default:o(()=>[e(c,{label:"进行中",value:"进行中"}),e(c,{label:"已完成",value:"已完成"}),e(c,{label:"已取消",value:"已取消"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(f,{span:12},{default:o(()=>[e(s,{label:"优先级",prop:"priority"},{default:o(()=>[e(h,{modelValue:t.projectData.priority,"onUpdate:modelValue":l[3]||(l[3]=a=>t.projectData.priority=a),placeholder:"选择优先级",style:{width:"100%"}},{default:o(()=>[e(c,{label:"高",value:"高"}),e(c,{label:"中",value:"中"}),e(c,{label:"低",value:"低"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(D,{gutter:20},{default:o(()=>[e(f,{span:12},{default:o(()=>[e(s,{label:"开始日期",prop:"start_date"},{default:o(()=>[e(n,{modelValue:t.projectData.start_date,"onUpdate:modelValue":l[4]||(l[4]=a=>t.projectData.start_date=a),type:"date",placeholder:"选择开始日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1}),e(f,{span:12},{default:o(()=>[e(s,{label:"结束日期",prop:"end_date"},{default:o(()=>[e(n,{modelValue:t.projectData.end_date,"onUpdate:modelValue":l[5]||(l[5]=a=>t.projectData.end_date=a),type:"date",placeholder:"选择结束日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(s,{label:"项目成员"},{default:o(()=>[t.loading?(m(),b("div",K,[e(p,{size:24,class:"is-loading"},{default:o(()=>[e(d)]),_:1}),l[10]||(l[10]=g("span",null,"加载用户列表...",-1))])):t.users.length===0?(m(),A(M,{key:1,description:"暂无其他用户可添加为项目成员"})):(m(),b("div",Q,[(m(!0),b(q,null,H(t.users,a=>(m(),b("div",{key:a.id,class:"member-item"},[e(k,{modelValue:t.selectedMembers,"onUpdate:modelValue":l[6]||(l[6]=S=>t.selectedMembers=S),label:a.id},{default:o(()=>[g("span",X,F(a.username),1),g("span",Z,"("+F(a.email)+")",1)]),_:2},1032,["modelValue","label"])]))),128)),g("div",$,"已选择 "+F(t.selectedMembers.length)+" 名成员",1)]))]),_:1}),e(s,{label:"项目文件"},{default:o(()=>[e(y,{ref:"fileUploadRef",onFileUploaded:t.handleFileUploaded,onFileRemoved:t.handleFileRemoved},null,8,["onFileUploaded","onFileRemoved"]),t.projectFiles.length>0?(m(),b("div",ee," 已上传 "+F(t.projectFiles.length)+" 个文件 ",1)):J("",!0)]),_:1}),e(s,{class:"form-buttons"},{default:o(()=>[e(_,{type:"primary","native-type":"submit",loading:t.creating},{default:o(()=>l[11]||(l[11]=[R("创建项目")])),_:1},8,["loading"]),e(_,{onClick:l[7]||(l[7]=a=>U.$router.push({name:"ProjectList"}))},{default:o(()=>l[12]||(l[12]=[R("取消")])),_:1})]),_:1})]),_:1},8,["model","onSubmit"])]),_:1})])}const ae=B(T,[["render",te],["__scopeId","data-v-d56bc142"]]);export{ae as default};
