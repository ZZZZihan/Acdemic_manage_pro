import{_ as X,y as V,C as L,j as O,z as Z,c as P,b as s,d as l,w as r,a as $,B as H,E as p,r as d,o as f,e as _,F as T,A as G,g as D,t as z}from"./index-9a8ac2de.js";import{u as ee}from"./user-be30f5d9.js";const te={name:"CreateMeeting",setup(){const S=$(),e=ee(),q=V(null),t=L({title:"",project_id:null,start_time:"",end_time:"",location:"",status:"pending",content:"",participants:[],attachments:[]}),B=V([]),F=V([]),i=V([]),b=V([]),m=V(!1),c=V(!1),v=L({selectedUsers:[]}),w="http://localhost:5003",U=O(()=>({Authorization:`Bearer ${e.token}`})),k={title:[{required:!0,message:"请输入会议标题",trigger:"blur"},{min:2,max:100,message:"长度在2到100个字符之间",trigger:"blur"}],start_time:[{required:!0,message:"请选择开始时间",trigger:"change"}],end_time:[{required:!0,message:"请选择结束时间",trigger:"change"},{validator:(o,n,u)=>{n&&t.start_time&&new Date(n)<=new Date(t.start_time)?u(new Error("结束时间必须晚于开始时间")):u()},trigger:"change"}],location:[{required:!0,message:"请输入会议地点",trigger:"blur"}],status:[{required:!0,message:"请选择会议状态",trigger:"change"}],content:[{required:!0,message:"请输入会议内容",trigger:"blur"}]},C=O(()=>F.value.filter(o=>{var n;return!i.value.some(u=>u.id===o.id)||o.id===((n=e.user)==null?void 0:n.id)})),Y=o=>o<new Date(new Date().setHours(0,0,0,0)),E=async o=>{if(o)try{const n=await H.get(`/api/v1/projects/${o}/members`);console.log("获取项目成员成功:",n.data);const y=(n.data.members||n.data||[]).map(g=>{const h=g.user||g;return{id:h.id,name:h.name||h.username,avatar:h.avatar||""}});i.value=M(i.value,y)}catch(n){console.error("获取项目成员失败:",n)}},M=(o,n)=>{const u=[...o];return n.forEach(y=>{u.some(g=>g.id===y.id)||u.push(y)}),u},x=o=>o.size>20971520?(p.error("文件大小不能超过20MB"),!1):!0,A=(o,n)=>{p.success("上传成功"),b.value.push({name:n.name,url:o.url,file_path:o.file_path})},a=()=>{p.error("上传失败")},N=()=>{v.selectedUsers=[],c.value=!0},R=o=>i.value.some(n=>n.id===o),I=()=>{if(v.selectedUsers.length===0){p.warning("请选择至少一名用户");return}const o=F.value.filter(n=>v.selectedUsers.includes(n.id)).map(n=>({id:n.id,name:n.name||n.username,avatar:n.avatar||""}));i.value=M(i.value,o),c.value=!1},J=o=>{i.value.splice(o,1)},K=async()=>{await q.value.validate(async o=>{var n,u,y;if(!o){p.error("请填写必填项");return}if(new Date(t.end_time)<=new Date(t.start_time)){p.error("结束时间必须晚于开始时间");return}if(i.value.length===0){p.error("请至少添加一名参会人员");return}m.value=!0;try{const g={...t,description:t.content,agenda:t.content,host_id:(n=e.user)==null?void 0:n.id,participants:i.value.map(j=>({user_id:j.id})),attachments:b.value.map(j=>({name:j.name,file_path:j.file_path}))},h=await H.post("/api/v1/meetings",g);p.success("会议创建成功"),S.push(`/meetings/${h.data.id}`)}catch(g){console.error("创建会议失败:",g),p.error("创建会议失败："+(((y=(u=g.response)==null?void 0:u.data)==null?void 0:y.message)||"未授权，请重新登录后再试"))}finally{m.value=!1}})},Q=async()=>{try{const o=await H.get("/api/v1/projects",{params:{limit:100,tab:"my"}});console.log("获取项目数据成功:",o.data),B.value=o.data.projects||o.data||[]}catch(o){console.error("获取项目列表失败:",o)}},W=async()=>{try{const o=await H.get("/api/v1/users");console.log("获取用户数据成功:",o.data),F.value=o.data||[],e.user&&(i.value=[{id:e.user.id,name:e.user.name||e.user.username,avatar:e.user.avatar||""}])}catch(o){console.error("获取用户列表失败:",o),p.error("获取用户列表失败，请刷新重试")}};return Z(()=>{Q(),W()}),{meetingFormRef:q,meetingForm:t,rules:k,projects:B,users:F,participants:i,attachments:b,submitting:m,participantDialogVisible:c,participantForm:v,baseUrl:w,uploadHeaders:U,availableUsers:C,disablePastDates:Y,handleProjectChange:E,beforeUpload:x,handleUploadSuccess:A,handleUploadError:a,showAddParticipantDialog:N,isUserSelected:R,addParticipants:I,removeParticipant:J,submitForm:K}}},ae={class:"create-meeting-container"},le={class:"page-header"},re={class:"time-range-picker"},oe={class:"participants-header"},ne={class:"user-info"},se={key:0,class:"empty-users"},ie={class:"user-option"},de={class:"dialog-footer"};function me(S,e,q,t,B,F){const i=d("el-button"),b=d("el-input"),m=d("el-form-item"),c=d("el-option"),v=d("el-select"),w=d("el-date-picker"),U=d("el-card"),k=d("el-empty"),C=d("el-avatar"),Y=d("el-table-column"),E=d("el-table"),M=d("el-upload"),x=d("el-form"),A=d("el-dialog");return f(),P("div",ae,[s("div",le,[e[13]||(e[13]=s("h2",null,"创建会议",-1)),s("div",null,[l(i,{onClick:e[0]||(e[0]=a=>S.$router.go(-1))},{default:r(()=>e[11]||(e[11]=[_("返回")])),_:1}),l(i,{type:"primary",onClick:t.submitForm,loading:t.submitting},{default:r(()=>e[12]||(e[12]=[_("保存")])),_:1},8,["onClick","loading"])])]),l(x,{ref:"meetingFormRef",model:t.meetingForm,rules:t.rules,"label-width":"100px",class:"meeting-form"},{default:r(()=>[l(U,{class:"form-card"},{header:r(()=>e[14]||(e[14]=[s("div",{class:"card-header"},[s("span",null,"基本信息")],-1)])),default:r(()=>[l(m,{label:"会议标题",prop:"title"},{default:r(()=>[l(b,{modelValue:t.meetingForm.title,"onUpdate:modelValue":e[1]||(e[1]=a=>t.meetingForm.title=a),placeholder:"请输入会议标题"},null,8,["modelValue"])]),_:1}),l(m,{label:"关联项目",prop:"project_id"},{default:r(()=>[l(v,{modelValue:t.meetingForm.project_id,"onUpdate:modelValue":e[2]||(e[2]=a=>t.meetingForm.project_id=a),placeholder:"请选择关联项目（可选）",filterable:"",clearable:"",onChange:t.handleProjectChange},{default:r(()=>[(f(!0),P(T,null,G(t.projects,a=>(f(),D(c,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),l(m,{label:"会议时间",required:""},{default:r(()=>[s("div",re,[l(m,{prop:"start_time",class:"time-item"},{default:r(()=>[l(w,{modelValue:t.meetingForm.start_time,"onUpdate:modelValue":e[3]||(e[3]=a=>t.meetingForm.start_time=a),type:"datetime",placeholder:"开始时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm","disabled-date":t.disablePastDates},null,8,["modelValue","disabled-date"])]),_:1}),e[15]||(e[15]=s("span",{class:"time-separator"},"至",-1)),l(m,{prop:"end_time",class:"time-item"},{default:r(()=>[l(w,{modelValue:t.meetingForm.end_time,"onUpdate:modelValue":e[4]||(e[4]=a=>t.meetingForm.end_time=a),type:"datetime",placeholder:"结束时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm","disabled-date":t.disablePastDates},null,8,["modelValue","disabled-date"])]),_:1})])]),_:1}),l(m,{label:"会议地点",prop:"location"},{default:r(()=>[l(b,{modelValue:t.meetingForm.location,"onUpdate:modelValue":e[5]||(e[5]=a=>t.meetingForm.location=a),placeholder:"请输入会议地点（线上会议可填写会议平台或链接）"},null,8,["modelValue"])]),_:1}),l(m,{label:"会议状态",prop:"status"},{default:r(()=>[l(v,{modelValue:t.meetingForm.status,"onUpdate:modelValue":e[6]||(e[6]=a=>t.meetingForm.status=a),placeholder:"请选择会议状态"},{default:r(()=>[l(c,{label:"未开始",value:"pending"}),l(c,{label:"进行中",value:"in_progress"}),l(c,{label:"已结束",value:"completed"}),l(c,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(U,{class:"form-card"},{header:r(()=>e[16]||(e[16]=[s("div",{class:"card-header"},[s("span",null,"会议内容")],-1)])),default:r(()=>[l(m,{label:"会议内容",prop:"content"},{default:r(()=>[l(b,{modelValue:t.meetingForm.content,"onUpdate:modelValue":e[7]||(e[7]=a=>t.meetingForm.content=a),type:"textarea",rows:6,placeholder:"请输入会议内容，包括会议描述和会议议程等信息"},null,8,["modelValue"])]),_:1})]),_:1}),l(U,{class:"form-card"},{header:r(()=>e[17]||(e[17]=[s("div",{class:"card-header"},[s("span",null,"参会人员")],-1)])),default:r(()=>[s("div",oe,[l(i,{type:"primary",onClick:t.showAddParticipantDialog,plain:"",size:"small",class:"add-participant-btn"},{default:r(()=>e[18]||(e[18]=[_(" 添加参会人员 ")])),_:1},8,["onClick"])]),t.participants.length===0?(f(),D(k,{key:0,description:"暂无参会人员"})):(f(),D(E,{key:1,data:t.participants,style:{width:"100%"}},{default:r(()=>[l(Y,{label:"姓名","min-width":"180"},{default:r(({row:a})=>[s("div",ne,[l(C,{size:30,src:a.avatar},{default:r(()=>[_(z(a.name.substring(0,1)),1)]),_:2},1032,["src"]),s("span",null,z(a.name),1)])]),_:1}),l(Y,{label:"操作",width:"100"},{default:r(({row:a,$index:N})=>[l(i,{type:"danger",size:"small",onClick:R=>t.removeParticipant(N),text:""},{default:r(()=>e[19]||(e[19]=[_(" 移除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1}),l(U,{class:"form-card"},{header:r(()=>e[20]||(e[20]=[s("div",{class:"card-header"},[s("span",null,"会议材料")],-1)])),default:r(()=>[l(M,{action:`${t.baseUrl}/api/v1/meetings/attachments/upload`,headers:t.uploadHeaders,"on-success":t.handleUploadSuccess,"on-error":t.handleUploadError,"before-upload":t.beforeUpload,"file-list":t.attachments,multiple:""},{tip:r(()=>e[22]||(e[22]=[s("div",{class:"el-upload__tip"}," 可以上传任意类型文件作为会议材料 ",-1)])),default:r(()=>[l(i,{type:"primary",plain:""},{default:r(()=>e[21]||(e[21]=[_("点击上传")])),_:1})]),_:1},8,["action","headers","on-success","on-error","before-upload","file-list"])]),_:1})]),_:1},8,["model","rules"]),l(A,{modelValue:t.participantDialogVisible,"onUpdate:modelValue":e[10]||(e[10]=a=>t.participantDialogVisible=a),title:"添加参会人员",width:"500px"},{footer:r(()=>[s("span",de,[l(i,{onClick:e[9]||(e[9]=a=>t.participantDialogVisible=!1)},{default:r(()=>e[23]||(e[23]=[_("取消")])),_:1}),l(i,{type:"primary",onClick:t.addParticipants},{default:r(()=>e[24]||(e[24]=[_("确定")])),_:1},8,["onClick"])])]),default:r(()=>[l(x,{model:t.participantForm,"label-width":"80px"},{default:r(()=>[l(m,{label:"选择用户"},{default:r(()=>[t.users.length===0?(f(),P("div",se,[l(k,{description:"暂无可选用户"})])):(f(),D(v,{key:1,modelValue:t.participantForm.selectedUsers,"onUpdate:modelValue":e[8]||(e[8]=a=>t.participantForm.selectedUsers=a),multiple:"",filterable:"",placeholder:"请选择要添加的用户",style:{width:"100%"}},{default:r(()=>[(f(!0),P(T,null,G(t.availableUsers,a=>(f(),D(c,{key:a.id,label:a.name||a.username,value:a.id,disabled:t.isUserSelected(a.id)},{default:r(()=>[s("div",ie,[l(C,{size:30},{default:r(()=>[_(z((a.name||a.username).substring(0,1)),1)]),_:2},1024),s("span",null,z(a.name||a.username),1)])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"]))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const pe=X(te,[["render",me],["__scopeId","data-v-08b99edf"]]);export{pe as default};
