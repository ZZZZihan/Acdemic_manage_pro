import{_ as Y,m as Z,W as $,y as p,j as J,z as ee,c as k,g,w as o,F as W,b as r,t as c,d as a,x as C,e as s,a as te,i as oe,B as U,E as m,r as f,o as u,L as le}from"./index-9a8ac2de.js";import{F as ae}from"./FileUpload-c7558ec6.js";const re={name:"ProjectDetail",components:{FileUpload:ae,Document:Z,Loading:$},setup(){const K=te(),l=oe(),i=p({}),e=p(!0),T=p(null),B=p(!1),x=p(!1),z=p(null),w=p(!1),P=p([]),h=p(null),_=p(!1),F=p(!1),v=J(()=>{const t=localStorage.getItem("user");if(t)try{return JSON.parse(t)}catch{return null}return null}),I=J(()=>{if(!v.value||!i.value)return!1;const t=v.value.id===i.value.creator_id,d=i.value.creator&&v.value.id===i.value.creator.id;return console.log("当前用户ID:",v.value.id),console.log("项目信息:",i.value),console.log("项目创建者ID:",i.value.creator_id),console.log("通过ID判断是否为创建者:",t),console.log("通过对象判断是否为创建者:",d),t||d}),y=J(()=>!v.value||!i.value||!i.value.members?!1:I.value?!0:i.value.members.some(t=>t.user_id===v.value.id)),E=async()=>{const t=l.params.id;if(!t)return T.value="项目ID无效",e.value=!1,Promise.reject("项目ID无效");e.value=!0;try{const d=localStorage.getItem("token"),D=await U.get(`/api/v1/projects/${t}`,{headers:{Authorization:`Bearer ${d}`}});return i.value=D.data,console.log("项目详情加载完成:",i.value),console.log("当前用户:",v.value),console.log("项目创建者ID:",i.value.creator_id),await b(),Promise.resolve(i.value)}catch(d){return console.error("加载项目详情失败:",d),T.value="加载项目详情失败，请稍后重试",Promise.reject(d)}finally{e.value=!1}},A=()=>{B.value=!0},M=async()=>{if(!I.value){m.error("只有项目创建者可以删除项目"),B.value=!1;return}x.value=!0;try{const t=localStorage.getItem("token");console.log("准备删除项目:",i.value.id),console.log("使用的认证令牌:",t?"令牌已提供":"令牌缺失"),await U.delete(`/api/v1/projects/${i.value.id}`,{headers:{Authorization:`Bearer ${t}`}}),m.success("项目已成功删除"),B.value=!1,K.push({name:"ProjectList"})}catch(t){console.error("删除项目失败:",t),t.response?(console.error("服务器响应:",t.response.status,t.response.data),t.response.status===403?m.error(t.response.data.msg||"您没有权限删除此项目"):m.error(t.response.data.msg||"删除项目失败，请稍后重试")):m.error("删除项目失败，请检查网络连接")}finally{x.value=!1}},V=async()=>{if(!y.value)return;const t=i.value.status;let d="进行中";t==="进行中"?d="已完成":t==="已完成"?d="已取消":t==="已取消"&&(d="进行中");try{const D=await U.put(`/api/v1/projects/${i.value.id}`,{status:d});i.value=D.data,m.success(`项目状态已更新为: ${d}`)}catch(D){console.error("更新项目状态失败:",D),m.error("更新项目状态失败，请稍后重试")}},j=()=>{switch(i.value.status){case"进行中":return"标记为已完成";case"已完成":return"标记为已取消";case"已取消":return"重新激活项目";default:return"更改状态"}},O=t=>{switch(t){case"进行中":return"success";case"已完成":return"primary";case"已取消":return"danger";default:return"info"}},G=t=>{if(!t)return"secondary";const d=["primary","success","warning","danger","info"],D=t.charCodeAt(0)%d.length;return d[D]},N=t=>t?t.charAt(0).toUpperCase():"?",n=t=>t?new Date(t).toLocaleDateString("zh-CN"):"未设置",S=t=>t?new Date(t).toLocaleString("zh-CN"):"未设置",b=async()=>{if(!i.value||!i.value.id){console.warn("无法加载项目文件：项目ID未定义");return}try{const t=i.value.id;console.log(`尝试加载项目 ${t} 的文件`);const d=await U.get(`/api/v1/projects/${t}/files`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});P.value=d.data||[]}catch(t){console.error("加载项目文件失败:",t),m.error("加载项目文件失败")}},L=async t=>{try{await U.post(`/api/v1/projects/${i.value.id}/files`,{file_path:t.file_path,original_name:t.original_name,file_size:t.file_size,file_type:t.file_type},{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),await b(),m.success("文件已成功添加到项目")}catch(d){console.error("关联文件到项目失败:",d),m.error("关联文件到项目失败")}},R=t=>{console.log("文件已移除",t)},q=t=>{h.value=t,_.value=!0},H=async()=>{if(!h.value||!h.value.id){_.value=!1;return}F.value=!0;try{await U.delete(`/api/v1/projects/${i.value.id}/files/${h.value.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),m.success("文件已成功删除"),await b()}catch(t){console.error("删除文件失败:",t),m.error("删除文件失败，请稍后重试")}finally{F.value=!1,_.value=!1}},Q=t=>{if(!t||!t.file_path)return;const d=`http://localhost:5003/api/v1/files/download/${t.file_path}`;window.open(d,"_blank")},X=t=>t?t<1024?t+" B":t<1024*1024?(t/1024).toFixed(2)+" KB":t<1024*1024*1024?(t/1024/1024).toFixed(2)+" MB":(t/1024/1024/1024).toFixed(2)+" GB":"未知大小";return ee(()=>{E().then(()=>{i.value&&i.value.id&&b()})}),{project:i,loading:e,error:T,isCreator:I,canEdit:y,showDeleteConfirm:B,deleting:x,confirmDelete:A,deleteProject:M,changeStatus:V,getNextStatusText:j,getStatusTagType:O,getColorByUsername:G,getInitials:N,formatDate:n,formatDateTime:S,fileUploadRef:z,showUploader:w,projectFiles:P,fileToDelete:h,showDeleteFileConfirm:_,deletingFile:F,handleFileUploaded:L,handleFileRemoved:R,confirmDeleteFile:q,deleteFile:H,downloadFile:Q,formatFileSize:X}}},ne={class:"project-detail"},se={class:"loading-container"},ie={class:"page-header"},de={class:"title-section"},ce={class:"page-title"},ue={class:"status-tags"},fe={class:"action-buttons"},_e={class:"meta-info"},me={class:"text-muted"},ve={class:"card-body"},pe={key:0},ge={class:"card-body"},ye={key:0},he={class:"user-info"},we={class:"user-details"},je={class:"username"},ke={class:"email"},be={class:"card-header"},De={key:0},Ce={key:0,class:"uploader-section"},Fe={key:1,class:"file-list"},Se={class:"file-name"},Ue={class:"project-info"},Be={class:"action-list"},xe={class:"dialog-footer"},Ie={class:"dialog-footer"};function Te(K,l,i,e,T,B){const x=f("Loading"),z=f("el-icon"),w=f("el-card"),P=f("el-alert"),h=f("el-tag"),_=f("el-button"),F=f("router-link"),v=f("el-empty"),I=f("el-avatar"),y=f("el-table-column"),E=f("el-table"),A=f("file-upload"),M=f("Document"),V=f("el-col"),j=f("el-descriptions-item"),O=f("el-descriptions"),G=f("el-row"),N=f("el-dialog");return u(),k("div",ne,[e.loading?(u(),g(w,{key:0,class:"loading-card"},{default:o(()=>[r("div",se,[a(z,{size:30,class:"is-loading"},{default:o(()=>[a(x)]),_:1}),l[6]||(l[6]=r("p",{class:"loading-text"},"加载项目信息...",-1))])]),_:1})):e.error?(u(),g(P,{key:1,type:"error",title:e.error,closable:!1},null,8,["title"])):(u(),k(W,{key:2},[r("div",ie,[r("div",de,[r("h2",ce,c(e.project.name),1),r("div",ue,[a(h,{type:e.getStatusTagType(e.project.status)},{default:o(()=>[s(c(e.project.status),1)]),_:1},8,["type"]),a(h,{type:"info",class:"ml-2"},{default:o(()=>[s("优先级: "+c(e.project.priority),1)]),_:1})])]),r("div",fe,[e.canEdit?(u(),g(F,{key:0,to:{name:"ProjectEdit",params:{id:e.project.id}}},{default:o(()=>[a(_,{type:"primary"},{default:o(()=>l[7]||(l[7]=[s("编辑项目")])),_:1})]),_:1},8,["to"])):C("",!0),e.isCreator?(u(),g(_,{key:1,type:"danger",onClick:e.confirmDelete,class:"ml-2"},{default:o(()=>l[8]||(l[8]=[s(" 删除项目 ")])),_:1},8,["onClick"])):C("",!0)])]),r("div",_e,[r("span",me,[s(" 创建于 "+c(e.formatDateTime(e.project.created_at))+" ",1),e.project.updated_at&&e.project.updated_at!==e.project.created_at?(u(),k(W,{key:0},[s(" · 更新于 "+c(e.formatDateTime(e.project.updated_at)),1)],64)):C("",!0)])]),a(G,{gutter:20},{default:o(()=>[a(V,{span:16},{default:o(()=>[a(w,{class:"content-card"},{header:o(()=>l[9]||(l[9]=[r("div",{class:"card-header"},[r("h3",null,"项目描述")],-1)])),default:o(()=>[r("div",ve,[e.project.description?(u(),k("p",pe,c(e.project.description),1)):(u(),g(v,{key:1,description:"暂无项目描述"}))])]),_:1}),a(w,{class:"content-card"},{header:o(()=>l[10]||(l[10]=[r("div",{class:"card-header"},[r("h3",null,"项目成员")],-1)])),default:o(()=>[r("div",ge,[e.project.members&&e.project.members.length>0?(u(),k("div",ye,[a(E,{data:e.project.members,style:{width:"100%"}},{default:o(()=>[a(y,{label:"用户名"},{default:o(n=>{var S,b,L;return[r("div",he,[a(I,{size:32,class:le(["member-avatar",`bg-${e.getColorByUsername((S=n.row.user)==null?void 0:S.username)}`])},{default:o(()=>{var R;return[s(c(e.getInitials((R=n.row.user)==null?void 0:R.username)),1)]}),_:2},1032,["class"]),r("div",we,[r("div",je,c(((b=n.row.user)==null?void 0:b.username)||"未知用户"),1),r("div",ke,c(((L=n.row.user)==null?void 0:L.email)||""),1)])])]}),_:1}),a(y,{prop:"role",label:"角色",width:"120"}),a(y,{label:"加入时间",width:"180"},{default:o(n=>[s(c(e.formatDateTime(n.row.created_at)),1)]),_:1})]),_:1},8,["data"])])):(u(),g(v,{key:1,description:"暂无项目成员"}))])]),_:1}),a(w,{class:"content-card"},{header:o(()=>[r("div",be,[l[13]||(l[13]=r("h3",null,"项目文件",-1)),e.canEdit?(u(),k("div",De,[e.showUploader?(u(),g(_,{key:1,size:"small",onClick:l[1]||(l[1]=n=>e.showUploader=!1)},{default:o(()=>l[12]||(l[12]=[s(" 取消上传 ")])),_:1})):(u(),g(_,{key:0,size:"small",type:"primary",onClick:l[0]||(l[0]=n=>e.showUploader=!0)},{default:o(()=>l[11]||(l[11]=[s(" 上传文件 ")])),_:1}))])):C("",!0)])]),default:o(()=>[e.showUploader&&e.canEdit?(u(),k("div",Ce,[a(A,{ref:"fileUploadRef",onFileUploaded:e.handleFileUploaded,onFileRemoved:e.handleFileRemoved},null,8,["onFileUploaded","onFileRemoved"])])):C("",!0),e.projectFiles.length>0?(u(),k("div",Fe,[a(E,{data:e.projectFiles,style:{width:"100%"}},{default:o(()=>[a(y,{label:"文件名","min-width":"200"},{default:o(n=>[r("div",Se,[a(z,{class:"file-icon"},{default:o(()=>[a(M)]),_:1}),r("span",null,c(n.row.original_name||"未命名文件"),1)])]),_:1}),a(y,{label:"大小",width:"120"},{default:o(n=>[s(c(e.formatFileSize(n.row.file_size)),1)]),_:1}),a(y,{label:"上传时间",width:"180"},{default:o(n=>[s(c(e.formatDateTime(n.row.created_at)),1)]),_:1}),a(y,{label:"操作",width:"150"},{default:o(n=>[a(_,{type:"primary",size:"small",onClick:S=>e.downloadFile(n.row),class:"mr-1"},{default:o(()=>l[14]||(l[14]=[s(" 下载 ")])),_:2},1032,["onClick"]),e.canEdit?(u(),g(_,{key:0,type:"danger",size:"small",onClick:S=>e.confirmDeleteFile(n.row)},{default:o(()=>l[15]||(l[15]=[s(" 删除 ")])),_:2},1032,["onClick"])):C("",!0)]),_:1})]),_:1},8,["data"])])):(u(),g(v,{key:2,description:"暂无项目文件"}))]),_:1})]),_:1}),a(V,{span:8},{default:o(()=>[a(w,{class:"content-card"},{header:o(()=>l[16]||(l[16]=[r("div",{class:"card-header"},[r("h3",null,"项目信息")],-1)])),default:o(()=>[r("div",Ue,[a(O,{column:1,border:""},{default:o(()=>[a(j,{label:"创建者"},{default:o(()=>{var n;return[s(c(((n=e.project.creator)==null?void 0:n.username)||"未知"),1)]}),_:1}),a(j,{label:"开始日期"},{default:o(()=>[s(c(e.formatDate(e.project.start_date)),1)]),_:1}),a(j,{label:"结束日期"},{default:o(()=>[s(c(e.formatDate(e.project.end_date)),1)]),_:1}),a(j,{label:"项目状态"},{default:o(()=>[a(h,{type:e.getStatusTagType(e.project.status)},{default:o(()=>[s(c(e.project.status),1)]),_:1},8,["type"])]),_:1}),a(j,{label:"优先级"},{default:o(()=>[s(c(e.project.priority),1)]),_:1}),a(j,{label:"成员数量"},{default:o(()=>{var n;return[s(c(((n=e.project.members)==null?void 0:n.length)||0),1)]}),_:1})]),_:1})])]),_:1}),a(w,{class:"content-card"},{header:o(()=>l[17]||(l[17]=[r("div",{class:"card-header"},[r("h3",null,"操作")],-1)])),default:o(()=>[r("div",Be,[a(F,{to:{name:"ProjectList"}},{default:o(()=>[a(_,{type:"info",class:"full-width-btn"},{default:o(()=>l[18]||(l[18]=[s("返回项目列表")])),_:1})]),_:1}),e.canEdit?(u(),g(_,{key:0,type:"primary",class:"full-width-btn mt-2",onClick:e.changeStatus},{default:o(()=>[s(c(e.getNextStatusText()),1)]),_:1},8,["onClick"])):C("",!0)])]),_:1})]),_:1})]),_:1}),a(N,{modelValue:e.showDeleteConfirm,"onUpdate:modelValue":l[3]||(l[3]=n=>e.showDeleteConfirm=n),title:"确认删除",width:"30%"},{footer:o(()=>[r("span",xe,[a(_,{onClick:l[2]||(l[2]=n=>e.showDeleteConfirm=!1)},{default:o(()=>l[21]||(l[21]=[s("取消")])),_:1}),a(_,{type:"danger",loading:e.deleting,onClick:e.deleteProject},{default:o(()=>[s(c(e.deleting?"删除中...":"确认删除"),1)]),_:1},8,["loading","onClick"])])]),default:o(()=>[r("span",null,[l[19]||(l[19]=s("确定要删除项目 ")),r("strong",null,c(e.project.name),1),l[20]||(l[20]=s(" 吗？这个操作不可撤销。"))])]),_:1},8,["modelValue"]),a(N,{modelValue:e.showDeleteFileConfirm,"onUpdate:modelValue":l[5]||(l[5]=n=>e.showDeleteFileConfirm=n),title:"确认删除文件",width:"30%"},{footer:o(()=>[r("span",Ie,[a(_,{onClick:l[4]||(l[4]=n=>e.showDeleteFileConfirm=!1)},{default:o(()=>l[24]||(l[24]=[s("取消")])),_:1}),a(_,{type:"danger",loading:e.deletingFile,onClick:e.deleteFile},{default:o(()=>[s(c(e.deletingFile?"删除中...":"确认删除"),1)]),_:1},8,["loading","onClick"])])]),default:o(()=>{var n;return[r("span",null,[l[22]||(l[22]=s("确定要删除文件 ")),r("strong",null,c((n=e.fileToDelete)==null?void 0:n.original_name),1),l[23]||(l[23]=s(" 吗？这个操作不可撤销。"))])]}),_:1},8,["modelValue"])],64))])}const Ee=Y(re,[["render",Te],["__scopeId","data-v-fc4be271"]]);export{Ee as default};
