import{_ as te,y,C as L,j as O,z as ae,c as S,b as i,d as o,w as r,g as k,a as le,i as oe,B as w,E as p,r as c,o as g,e as b,F as T,A as G,t as q}from"./index-9a8ac2de.js";import{u as re}from"./user-be30f5d9.js";const ne={name:"MeetingEdit",setup(){const D=le(),C=oe().params.id,t=re(),B=y(null),M=y(!0),s=L({title:"",project_id:null,start_time:"",end_time:"",location:"",status:"pending",content:"",participants:[],attachments:[]}),Y=y([]),_=y([]),d=y([]),u=y([]),f=y(!1),h=y(!1),V=L({selectedUsers:[]}),j="http://localhost:5003",x=O(()=>({Authorization:`Bearer ${t.token}`})),P={title:[{required:!0,message:"请输入会议标题",trigger:"blur"},{min:2,max:100,message:"长度在2到100个字符之间",trigger:"blur"}],start_time:[{required:!0,message:"请选择开始时间",trigger:"change"}],end_time:[{required:!0,message:"请选择结束时间",trigger:"change"},{validator:(n,a,m)=>{a&&s.start_time&&new Date(a)<=new Date(s.start_time)?m(new Error("结束时间必须晚于开始时间")):m()},trigger:"change"}],location:[{required:!0,message:"请输入会议地点",trigger:"blur"}],status:[{required:!0,message:"请选择会议状态",trigger:"change"}],content:[{required:!0,message:"请输入会议内容",trigger:"blur"}]},A=O(()=>_.value.filter(n=>!d.value.some(a=>a.id===n.id))),R=n=>n<new Date(new Date().setHours(0,0,0,0)),H=async n=>{if(n)try{const a=await w.get(`/api/v1/projects/${n}/members`);console.log("获取项目成员成功:",a.data);const U=(a.data.members||a.data||[]).map(v=>{const F=v.user||v;return{id:F.id,name:F.name||F.username,avatar:F.avatar||""}});d.value=E(d.value,U)}catch(a){console.error("获取项目成员失败:",a)}},E=(n,a)=>{const m=[...n];return a.forEach(U=>{m.some(v=>v.id===U.id)||m.push(U)}),m},l=n=>n.size>20971520?(p.error("文件大小不能超过20MB"),!1):!0,N=(n,a)=>{p.success("上传成功"),u.value.push({name:a.name,url:n.url,file_path:n.file_path})},I=()=>{p.error("上传失败")},J=()=>{V.selectedUsers=[],h.value=!0},K=n=>d.value.some(a=>a.id===n),Q=()=>{if(V.selectedUsers.length===0){p.warning("请选择至少一名用户");return}const n=_.value.filter(a=>V.selectedUsers.includes(a.id)).map(a=>({id:a.id,name:a.name||a.username,avatar:a.avatar||""}));d.value=E(d.value,n),h.value=!1},W=n=>{d.value.splice(n,1)},X=async()=>{await B.value.validate(async n=>{var a,m,U;if(!n){p.error("请填写必填项");return}if(new Date(s.end_time)<=new Date(s.start_time)){p.error("结束时间必须晚于开始时间");return}if(d.value.length===0){p.error("请至少添加一名参会人员");return}f.value=!0;try{const v={...s,description:s.content,agenda:s.content,host_id:(a=t.user)==null?void 0:a.id,participants:d.value.map(z=>({user_id:z.id})),attachments:u.value.map(z=>({name:z.name,file_path:z.file_path}))},F=await w.put(`/api/v1/meetings/${C}`,v);p.success("会议更新成功"),D.push(`/meetings/${C}`)}catch(v){console.error("更新会议失败:",v),p.error("更新会议失败："+(((U=(m=v.response)==null?void 0:m.data)==null?void 0:U.message)||"未授权，请重新登录后再试"))}finally{f.value=!1}})},Z=async()=>{M.value=!0;try{const a=(await w.get(`/api/v1/meetings/${C}`)).data;s.title=a.title,s.project_id=a.project_id,s.start_time=a.start_time,s.end_time=a.end_time,s.location=a.location,s.status=a.status,s.content=a.description||a.agenda||"",a.participants&&a.participants.length>0&&(d.value=a.participants.map(m=>({id:m.user.id,name:m.user.name||m.user.username,avatar:m.user.avatar||""}))),a.attachments&&a.attachments.length>0&&(u.value=a.attachments),console.log("会议数据加载成功:",a)}catch(n){console.error("加载会议详情失败:",n),p.error("加载会议详情失败，请稍后再试"),D.push("/meetings")}finally{M.value=!1}},$=async()=>{try{const n=await w.get("/api/v1/projects",{params:{limit:100,tab:"my"}});console.log("获取项目数据成功:",n.data),Y.value=n.data.projects||n.data||[]}catch(n){console.error("获取项目列表失败:",n)}},ee=async()=>{try{const n=await w.get("/api/v1/users");console.log("获取用户数据成功:",n.data),_.value=n.data||[]}catch(n){console.error("获取用户列表失败:",n),p.error("获取用户列表失败，请刷新重试")}};return ae(()=>{Z(),$(),ee()}),{meetingFormRef:B,meetingForm:s,rules:P,projects:Y,users:_,participants:d,attachments:u,loading:M,submitting:f,participantDialogVisible:h,participantForm:V,baseUrl:j,uploadHeaders:x,availableUsers:A,disablePastDates:R,handleProjectChange:H,beforeUpload:l,handleUploadSuccess:N,handleUploadError:I,showAddParticipantDialog:J,isUserSelected:K,addParticipants:Q,removeParticipant:W,submitForm:X}}},se={class:"edit-meeting-container"},ie={class:"page-header"},de={class:"time-range-picker"},me={class:"participants-header"},ce={class:"user-info"},ue={key:0,class:"empty-users"},pe={class:"user-option"},ge={class:"dialog-footer"};function _e(D,e,C,t,B,M){const s=c("el-button"),Y=c("el-skeleton"),_=c("el-card"),d=c("el-input"),u=c("el-form-item"),f=c("el-option"),h=c("el-select"),V=c("el-date-picker"),j=c("el-empty"),x=c("el-avatar"),P=c("el-table-column"),A=c("el-table"),R=c("el-upload"),H=c("el-form"),E=c("el-dialog");return g(),S("div",se,[i("div",ie,[e[13]||(e[13]=i("h2",null,"编辑会议",-1)),i("div",null,[o(s,{onClick:e[0]||(e[0]=l=>D.$router.go(-1))},{default:r(()=>e[11]||(e[11]=[b("返回")])),_:1}),o(s,{type:"primary",onClick:t.submitForm,loading:t.submitting},{default:r(()=>e[12]||(e[12]=[b("保存")])),_:1},8,["onClick","loading"])])]),t.loading?(g(),k(_,{key:0,class:"loading-card"},{default:r(()=>[o(Y,{rows:10,animated:""})]),_:1})):(g(),k(H,{key:1,ref:"meetingFormRef",model:t.meetingForm,rules:t.rules,"label-width":"100px",class:"meeting-form"},{default:r(()=>[o(_,{class:"form-card"},{header:r(()=>e[14]||(e[14]=[i("div",{class:"card-header"},[i("span",null,"基本信息")],-1)])),default:r(()=>[o(u,{label:"会议标题",prop:"title"},{default:r(()=>[o(d,{modelValue:t.meetingForm.title,"onUpdate:modelValue":e[1]||(e[1]=l=>t.meetingForm.title=l),placeholder:"请输入会议标题"},null,8,["modelValue"])]),_:1}),o(u,{label:"关联项目",prop:"project_id"},{default:r(()=>[o(h,{modelValue:t.meetingForm.project_id,"onUpdate:modelValue":e[2]||(e[2]=l=>t.meetingForm.project_id=l),placeholder:"请选择关联项目（可选）",filterable:"",clearable:"",onChange:t.handleProjectChange},{default:r(()=>[(g(!0),S(T,null,G(t.projects,l=>(g(),k(f,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),o(u,{label:"会议时间",required:""},{default:r(()=>[i("div",de,[o(u,{prop:"start_time",class:"time-item"},{default:r(()=>[o(V,{modelValue:t.meetingForm.start_time,"onUpdate:modelValue":e[3]||(e[3]=l=>t.meetingForm.start_time=l),type:"datetime",placeholder:"开始时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm","disabled-date":t.disablePastDates},null,8,["modelValue","disabled-date"])]),_:1}),e[15]||(e[15]=i("span",{class:"time-separator"},"至",-1)),o(u,{prop:"end_time",class:"time-item"},{default:r(()=>[o(V,{modelValue:t.meetingForm.end_time,"onUpdate:modelValue":e[4]||(e[4]=l=>t.meetingForm.end_time=l),type:"datetime",placeholder:"结束时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm","disabled-date":t.disablePastDates},null,8,["modelValue","disabled-date"])]),_:1})])]),_:1}),o(u,{label:"会议地点",prop:"location"},{default:r(()=>[o(d,{modelValue:t.meetingForm.location,"onUpdate:modelValue":e[5]||(e[5]=l=>t.meetingForm.location=l),placeholder:"请输入会议地点（线上会议可填写会议平台或链接）"},null,8,["modelValue"])]),_:1}),o(u,{label:"会议状态",prop:"status"},{default:r(()=>[o(h,{modelValue:t.meetingForm.status,"onUpdate:modelValue":e[6]||(e[6]=l=>t.meetingForm.status=l),placeholder:"请选择会议状态"},{default:r(()=>[o(f,{label:"未开始",value:"pending"}),o(f,{label:"进行中",value:"in_progress"}),o(f,{label:"已结束",value:"completed"}),o(f,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),o(_,{class:"form-card"},{header:r(()=>e[16]||(e[16]=[i("div",{class:"card-header"},[i("span",null,"会议内容")],-1)])),default:r(()=>[o(u,{label:"会议内容",prop:"content"},{default:r(()=>[o(d,{modelValue:t.meetingForm.content,"onUpdate:modelValue":e[7]||(e[7]=l=>t.meetingForm.content=l),type:"textarea",rows:6,placeholder:"请输入会议内容，包括会议描述和会议议程等信息"},null,8,["modelValue"])]),_:1})]),_:1}),o(_,{class:"form-card"},{header:r(()=>e[17]||(e[17]=[i("div",{class:"card-header"},[i("span",null,"参会人员")],-1)])),default:r(()=>[i("div",me,[o(s,{type:"primary",onClick:t.showAddParticipantDialog,plain:"",size:"small",class:"add-participant-btn"},{default:r(()=>e[18]||(e[18]=[b(" 添加参会人员 ")])),_:1},8,["onClick"])]),t.participants.length===0?(g(),k(j,{key:0,description:"暂无参会人员"})):(g(),k(A,{key:1,data:t.participants,style:{width:"100%"}},{default:r(()=>[o(P,{label:"姓名","min-width":"180"},{default:r(({row:l})=>[i("div",ce,[o(x,{size:30,src:l.avatar},{default:r(()=>[b(q(l.name.substring(0,1)),1)]),_:2},1032,["src"]),i("span",null,q(l.name),1)])]),_:1}),o(P,{label:"操作",width:"100"},{default:r(({row:l,$index:N})=>[o(s,{type:"danger",size:"small",onClick:I=>t.removeParticipant(N),text:""},{default:r(()=>e[19]||(e[19]=[b(" 移除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1}),o(_,{class:"form-card"},{header:r(()=>e[20]||(e[20]=[i("div",{class:"card-header"},[i("span",null,"会议材料")],-1)])),default:r(()=>[o(R,{action:`${t.baseUrl}/api/v1/meetings/attachments/upload`,headers:t.uploadHeaders,"on-success":t.handleUploadSuccess,"on-error":t.handleUploadError,"before-upload":t.beforeUpload,"file-list":t.attachments,multiple:""},{tip:r(()=>e[22]||(e[22]=[i("div",{class:"el-upload__tip"}," 可以上传任意类型文件作为会议材料 ",-1)])),default:r(()=>[o(s,{type:"primary",plain:""},{default:r(()=>e[21]||(e[21]=[b("点击上传")])),_:1})]),_:1},8,["action","headers","on-success","on-error","before-upload","file-list"])]),_:1})]),_:1},8,["model","rules"])),o(E,{modelValue:t.participantDialogVisible,"onUpdate:modelValue":e[10]||(e[10]=l=>t.participantDialogVisible=l),title:"添加参会人员",width:"500px"},{footer:r(()=>[i("span",ge,[o(s,{onClick:e[9]||(e[9]=l=>t.participantDialogVisible=!1)},{default:r(()=>e[23]||(e[23]=[b("取消")])),_:1}),o(s,{type:"primary",onClick:t.addParticipants},{default:r(()=>e[24]||(e[24]=[b("确定")])),_:1},8,["onClick"])])]),default:r(()=>[o(H,{model:t.participantForm,"label-width":"80px"},{default:r(()=>[o(u,{label:"选择用户"},{default:r(()=>[t.users.length===0?(g(),S("div",ue,[o(j,{description:"暂无可选用户"})])):(g(),k(h,{key:1,modelValue:t.participantForm.selectedUsers,"onUpdate:modelValue":e[8]||(e[8]=l=>t.participantForm.selectedUsers=l),multiple:"",filterable:"",placeholder:"请选择要添加的用户",style:{width:"100%"}},{default:r(()=>[(g(!0),S(T,null,G(t.availableUsers,l=>(g(),k(f,{key:l.id,label:l.name||l.username,value:l.id,disabled:t.isUserSelected(l.id)},{default:r(()=>[i("div",pe,[o(x,{size:30},{default:r(()=>[b(q((l.name||l.username).substring(0,1)),1)]),_:2},1024),i("span",null,q(l.name||l.username),1)])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"]))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const be=te(ne,[["render",_e],["__scopeId","data-v-c3e65101"]]);export{be as default};
