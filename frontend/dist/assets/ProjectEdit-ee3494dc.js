import{_ as W,W as G,y as _,C as K,j as Q,z as X,c as g,g as z,w as r,F as H,b as y,d as e,a as Z,i as $,B as V,E as I,r as d,o as p,e as O,H as ee,A as te,t as C,x as J}from"./index-9a8ac2de.js";import{F as oe}from"./FileUpload-c7558ec6.js";const ae={name:"ProjectEdit",components:{FileUpload:oe,Loading:G},setup(){const Y=Z(),o=$(),T=_(null),t=_(!0),S=_(!1),x=_(!1),D=_(null),w=_([]),k=_([]),m=o.params.id,c=K({name:"",description:"",status:"进行中",priority:"中",start_date:"",end_date:""}),v=Q(()=>{const a=localStorage.getItem("user");if(a)try{return JSON.parse(a)}catch{return null}return null}),j=_(!1),f=_(null),u=_([]),F=_(!1),h=_([]),B=async()=>{var a;if(!m){D.value="项目ID无效",t.value=!1;return}t.value=!0;try{const s=localStorage.getItem("token"),l=(await V.get(`/api/v1/projects/${m}`,{headers:{Authorization:`Bearer ${s}`}})).data;c.name=l.name,c.description=l.description||"",c.status=l.status,c.priority=l.priority,l.start_date&&(c.start_date=i(l.start_date)),l.end_date&&(c.end_date=i(l.end_date));const U=v.value&&l.creator_id===v.value.id,q=v.value&&l.creator&&l.creator.id===v.value.id;if(j.value=U||q,console.log("当前用户ID:",(a=v.value)==null?void 0:a.id),console.log("项目创建者ID:",l.creator_id),console.log("是否为创建者:",j.value),l.members){console.log("项目成员:",l.members);const P=l.members.filter(b=>b.user_id&&v.value&&b.user_id!==v.value.id).map(b=>(typeof b.user_id=="number",b.user_id));console.log("提取的成员ID:",P),k.value=P}}catch(s){console.error("加载项目详情失败:",s),D.value="加载项目详情失败，请稍后重试"}finally{t.value=!1}},M=async()=>{if(j.value){S.value=!0;try{const a=await V.get("/api/v1/users");w.value=a.data.filter(s=>{var n;return s.id!==((n=v.value)==null?void 0:n.id)})}catch(a){console.error("加载用户列表失败:",a),I.error("加载用户列表失败")}finally{S.value=!1}}},R=async()=>{if(m){F.value=!0;try{const a=localStorage.getItem("token"),s=await V.get(`/api/v1/projects/${m}/files`,{headers:{Authorization:`Bearer ${a}`}});u.value=s.data||[]}catch(a){console.error("加载项目文件失败:",a),I.error("加载项目文件失败")}finally{F.value=!1}}},A=async a=>{try{u.value.push(a)}catch(s){console.error("添加文件失败:",s)}},E=a=>{a.id&&h.value.push(a.id);const s=u.value.findIndex(n=>n.id&&n.id===a.id||n.file_path&&n.file_path===a.file_path);s!==-1&&u.value.splice(s,1)},N=async()=>{const a=localStorage.getItem("token");for(const n of h.value)try{await V.delete(`/api/v1/projects/${m}/files/${n}`,{headers:{Authorization:`Bearer ${a}`}})}catch(l){console.error(`删除文件 ${n} 失败:`,l)}const s=u.value.filter(n=>!n.id);for(const n of s)try{await V.post(`/api/v1/projects/${m}/files`,{file_path:n.file_path,original_name:n.original_name,file_size:n.file_size,file_type:n.file_type},{headers:{Authorization:`Bearer ${a}`}})}catch(l){console.error("关联文件到项目失败:",l)}},L=async()=>{var a,s,n;x.value=!0;try{const l={name:c.name,description:c.description,status:c.status,priority:c.priority,start_date:c.start_date||null,end_date:c.end_date||null};if(j.value){const P=[...k.value];l.members=P.map(b=>({user_id:b,role:"成员"}))}const U=localStorage.getItem("token"),q=await V.put(`/api/v1/projects/${m}`,l,{headers:{Authorization:`Bearer ${U}`}});await N(),I.success("项目已成功更新"),Y.push({name:"ProjectDetail",params:{id:m}})}catch(l){console.error("更新项目失败:",l),((a=l.response)==null?void 0:a.status)===403?I.error(l.response.data.msg||"您没有权限编辑此项目"):I.error(((n=(s=l.response)==null?void 0:s.data)==null?void 0:n.message)||"更新项目失败，请稍后重试")}finally{x.value=!1}},i=a=>{if(!a)return"";const s=new Date(a),n=s.getFullYear(),l=(s.getMonth()+1).toString().padStart(2,"0"),U=s.getDate().toString().padStart(2,"0");return`${n}-${l}-${U}`};return X(()=>{B(),M(),R()}),{projectForm:T,projectId:m,projectData:c,loading:t,loadingUsers:S,updating:x,error:D,users:w,selectedMembers:k,isCreator:j,fileUploadRef:f,projectFiles:u,loadingFiles:F,handleFileUploaded:A,handleFileRemoved:E,updateProject:L}}},le={class:"project-edit"},re={class:"loading-container"},ne={class:"page-header"},se={key:0,class:"loading-container"},ie={key:2,class:"member-list"},de={class:"member-name"},ce={class:"member-email"},ue={class:"selected-count"},pe={key:0,class:"loading-container"},_e={key:1},me={key:0,class:"file-list-info mt-2"};function fe(Y,o,T,t,S,x){const D=d("Loading"),w=d("el-icon"),k=d("el-card"),m=d("el-alert"),c=d("el-button"),v=d("router-link"),j=d("el-input"),f=d("el-form-item"),u=d("el-option"),F=d("el-select"),h=d("el-col"),B=d("el-row"),M=d("el-date-picker"),R=d("el-empty"),A=d("el-checkbox"),E=d("el-spinner"),N=d("file-upload"),L=d("el-form");return p(),g("div",le,[t.loading?(p(),z(k,{key:0,class:"loading-card"},{default:r(()=>[y("div",re,[e(w,{size:30,class:"is-loading"},{default:r(()=>[e(D)]),_:1}),o[8]||(o[8]=y("p",{class:"loading-text"},"加载项目信息...",-1))])]),_:1})):t.error?(p(),z(m,{key:1,type:"error",title:t.error,closable:!1},null,8,["title"])):(p(),g(H,{key:2},[y("div",ne,[o[10]||(o[10]=y("h2",{class:"page-title"},"编辑项目",-1)),e(v,{to:{name:"ProjectDetail",params:{id:t.projectId}}},{default:r(()=>[e(c,null,{default:r(()=>o[9]||(o[9]=[O("返回")])),_:1})]),_:1},8,["to"])]),e(k,null,{default:r(()=>[e(L,{ref:"projectForm",model:t.projectData,"label-width":"100px",onSubmit:ee(t.updateProject,["prevent"])},{default:r(()=>[e(f,{label:"项目名称",prop:"name"},{default:r(()=>[e(j,{modelValue:t.projectData.name,"onUpdate:modelValue":o[0]||(o[0]=i=>t.projectData.name=i),placeholder:"输入项目名称",required:""},null,8,["modelValue"])]),_:1}),e(f,{label:"项目描述",prop:"description"},{default:r(()=>[e(j,{modelValue:t.projectData.description,"onUpdate:modelValue":o[1]||(o[1]=i=>t.projectData.description=i),type:"textarea",rows:5,placeholder:"输入项目描述"},null,8,["modelValue"])]),_:1}),e(B,{gutter:20},{default:r(()=>[e(h,{span:12},{default:r(()=>[e(f,{label:"项目状态",prop:"status"},{default:r(()=>[e(F,{modelValue:t.projectData.status,"onUpdate:modelValue":o[2]||(o[2]=i=>t.projectData.status=i),placeholder:"选择项目状态",style:{width:"100%"}},{default:r(()=>[e(u,{label:"进行中",value:"进行中"}),e(u,{label:"已完成",value:"已完成"}),e(u,{label:"已取消",value:"已取消"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(h,{span:12},{default:r(()=>[e(f,{label:"优先级",prop:"priority"},{default:r(()=>[e(F,{modelValue:t.projectData.priority,"onUpdate:modelValue":o[3]||(o[3]=i=>t.projectData.priority=i),placeholder:"选择优先级",style:{width:"100%"}},{default:r(()=>[e(u,{label:"高",value:"高"}),e(u,{label:"中",value:"中"}),e(u,{label:"低",value:"低"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(B,{gutter:20},{default:r(()=>[e(h,{span:12},{default:r(()=>[e(f,{label:"开始日期",prop:"start_date"},{default:r(()=>[e(M,{modelValue:t.projectData.start_date,"onUpdate:modelValue":o[4]||(o[4]=i=>t.projectData.start_date=i),type:"date",placeholder:"选择开始日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1}),e(h,{span:12},{default:r(()=>[e(f,{label:"结束日期",prop:"end_date"},{default:r(()=>[e(M,{modelValue:t.projectData.end_date,"onUpdate:modelValue":o[5]||(o[5]=i=>t.projectData.end_date=i),type:"date",placeholder:"选择结束日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t.isCreator?(p(),z(f,{key:0,label:"项目成员"},{default:r(()=>[t.loadingUsers?(p(),g("div",se,[e(w,{size:24,class:"is-loading"},{default:r(()=>[e(D)]),_:1}),o[11]||(o[11]=y("span",null,"加载用户列表...",-1))])):t.users.length===0?(p(),z(R,{key:1,description:"暂无其他用户可添加为项目成员"})):(p(),g("div",ie,[(p(!0),g(H,null,te(t.users,i=>(p(),g("div",{key:i.id,class:"member-item"},[e(A,{modelValue:t.selectedMembers,"onUpdate:modelValue":o[6]||(o[6]=a=>t.selectedMembers=a),label:i.id},{default:r(()=>[y("span",de,C(i.username),1),y("span",ce,"("+C(i.email)+")",1)]),_:2},1032,["modelValue","label"])]))),128)),y("div",ue,"已选择 "+C(t.selectedMembers.length)+" 名成员",1)]))]),_:1})):J("",!0),e(f,{label:"项目文件"},{default:r(()=>[t.loadingFiles?(p(),g("div",pe,[e(E),o[12]||(o[12]=y("span",null,"加载文件列表...",-1))])):(p(),g("div",_e,[e(N,{ref:"fileUploadRef","initial-files":t.projectFiles,onFileUploaded:t.handleFileUploaded,onFileRemoved:t.handleFileRemoved},null,8,["initial-files","onFileUploaded","onFileRemoved"]),t.projectFiles.length>0?(p(),g("div",me," 已上传 "+C(t.projectFiles.length)+" 个文件 ",1)):J("",!0)]))]),_:1}),e(f,{class:"form-buttons"},{default:r(()=>[e(c,{type:"primary","native-type":"submit",loading:t.updating},{default:r(()=>o[13]||(o[13]=[O("保存修改")])),_:1},8,["loading"]),e(c,{onClick:o[7]||(o[7]=i=>Y.$router.push({name:"ProjectDetail",params:{id:t.projectId}}))},{default:r(()=>o[14]||(o[14]=[O("取消")])),_:1})]),_:1})]),_:1},8,["model","onSubmit"])]),_:1})],64))])}const ye=W(ae,[["render",fe],["__scopeId","data-v-0244331f"]]);export{ye as default};
