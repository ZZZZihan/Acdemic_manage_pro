import{_ as ue,h as pe,m as _e,j,y as v,C as le,z as fe,D as ge,c as y,b as i,t as d,d as o,w as n,g,x as w,i as ve,a as ye,B as V,E as _,J as ie,r as c,G as we,o as m,e as r,F as se,A as re}from"./index-9a8ac2de.js";import{u as he}from"./user-be30f5d9.js";function ke(h,t="YYYY-MM-DD"){if(!h)return"";const p=new Date(h);if(isNaN(p.getTime()))return console.error("Invalid date:",h),"";const e=p.getFullYear(),x=String(p.getMonth()+1).padStart(2,"0"),A=String(p.getDate()).padStart(2,"0"),s=String(p.getHours()).padStart(2,"0"),B=String(p.getMinutes()).padStart(2,"0"),T=String(p.getSeconds()).padStart(2,"0");return t.replace("YYYY",e).replace("MM",x).replace("DD",A).replace("HH",s).replace("mm",B).replace("ss",T)}const be={name:"MeetingDetail",components:{ArrowDown:pe,Document:_e},setup(){const h=ve(),t=ye(),p=he(),e=j(()=>h.params.id),x=v(!0),A=v(!1),s=v({title:"",start_time:"",end_time:"",location:"",status:"pending",project:null,agenda:"",notes:"",creator:null,participants:[],attachments:[],minutes:null,created_at:""}),B=j(()=>{var H,te,ne,ae,oe;console.log("检查编辑权限:",{meetingCreator:((H=s.value.creator)==null?void 0:H.id)||s.value.host_id,currentUser:(te=p.user)==null?void 0:te.id,isAdmin:p.isAdmin});const l=((ne=s.value.creator)==null?void 0:ne.id)===((ae=p.user)==null?void 0:ae.id),u=s.value.host_id===((oe=p.user)==null?void 0:oe.id),ee=p.isAdmin;return l||u||ee}),T=j(()=>({pending:"primary",in_progress:"success",completed:"info",cancelled:"danger"})[s.value.status]||"info"),N=j(()=>({pending:"未开始",in_progress:"进行中",completed:"已结束",cancelled:"已取消"})[s.value.status]||"未知状态"),O=l=>({accepted:"success",pending:"info",declined:"danger"})[l]||"info",R=l=>({accepted:"已接受",pending:"待回复",declined:"已拒绝"})[l]||"未知状态",S=l=>l?ke(new Date(l),"YYYY-MM-DD HH:mm"):"未设置",E=l=>{if(!l)return"0 B";const u=1024,ee=["B","KB","MB","GB","TB"],H=Math.floor(Math.log(l)/Math.log(u));return parseFloat((l/Math.pow(u,H)).toFixed(2))+" "+ee[H]},Y=j(()=>({Authorization:`Bearer ${p.token}`})),f=async()=>{x.value=!0;try{const l=await V.get(`/api/v1/meetings/${e.value}`);s.value=l.data}catch(l){console.error("获取会议详情失败:",l),l.response&&l.response.status===404?A.value=!0:_.error("获取会议详情失败")}finally{x.value=!1}},J=()=>{t.push(`/meetings/${e.value}/edit`)},K=l=>{l==="duplicate"?C():l==="delete"&&(Z.value=!0)},C=()=>{t.push({path:"/meetings/create",query:{duplicate:e.value}})},k=v(!1),b=le({user_id:null,role:"参会者"}),I=v([]),P=v(!1),M=v(!1),L=()=>{b.user_id=null,b.role="参会者",k.value=!0},G=async l=>{if(!(l.length<2)){P.value=!0;try{const u=await V.get("/api/v1/users/search",{params:{query:l}});I.value=u.data}catch(u){console.error("搜索用户失败:",u)}finally{P.value=!1}}},q=async()=>{if(!b.user_id){_.warning("请选择用户");return}M.value=!0;try{await V.post(`/api/v1/meetings/${e.value}/participants`,{user_id:b.user_id,role:b.role}),_.success("添加参会人员成功"),f(),k.value=!1}catch(l){console.error("添加参会人员失败:",l),_.error("添加参会人员失败")}finally{M.value=!1}},U=async l=>{try{await ie.confirm(`确定移除参会人员 ${l.user.name} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await V.delete(`/api/v1/meetings/${e.value}/participants/${l.id}`),_.success("移除参会人员成功"),f()}catch(u){u!=="cancel"&&(console.error("移除参会人员失败:",u),_.error("移除参会人员失败"))}},Q=()=>{_.success("附件上传成功"),f()},W=()=>{_.error("附件上传失败")},a=l=>{window.open(l.url,"_blank")},D=async l=>{try{await ie.confirm(`确定删除附件 ${l.name} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await V.delete(`/api/v1/meetings/${e.value}/attachments/${l.id}`),_.success("删除附件成功"),f()}catch(u){u!=="cancel"&&(console.error("删除附件失败:",u),_.error("删除附件失败"))}},F=v(!1),z=le({content:""}),X=v(!1),de=()=>{z.content=s.value.minutes||"",F.value=!0},ce=async()=>{X.value=!0;try{await V.put(`/api/v1/meetings/${e.value}/minutes`,{content:z.content}),_.success("保存会议纪要成功"),f(),F.value=!1}catch(l){console.error("保存会议纪要失败:",l),_.error("保存会议纪要失败")}finally{X.value=!1}},Z=v(!1),$=v(!1),me=async()=>{$.value=!0;try{await V.delete(`/api/v1/meetings/${e.value}`),_.success("删除会议成功"),t.push("/meetings")}catch(l){console.error("删除会议失败:",l),_.error("删除会议失败")}finally{$.value=!1,Z.value=!1}};return fe(()=>{f()}),{meetingId:e,meeting:s,loading:x,notFound:A,canEdit:B,statusType:T,statusText:N,formatDateTime:S,formatFileSize:E,uploadHeaders:Y,editMeeting:J,handleCommand:K,participantDialogVisible:k,participantForm:b,userOptions:I,searchingUsers:P,addingParticipant:M,showAddParticipant:L,searchUsers:G,addParticipant:q,removeParticipant:U,getParticipantStatusType:O,getParticipantStatusText:R,handleAttachmentSuccess:Q,handleAttachmentError:W,downloadAttachment:a,removeAttachment:D,minutesDialogVisible:F,minutesForm:z,savingMinutes:X,editMinutes:de,saveMinutes:ce,deleteConfirmVisible:Z,deleting:$,confirmDelete:me}}},Me={class:"meeting-detail-container"},Ce={class:"page-header"},De={key:1,class:"meeting-detail-content"},Ve={class:"card-header"},xe={class:"user-info"},Te={key:1},Se={class:"content-section"},Fe={class:"content-text"},ze={key:0,class:"content-section"},Ae={class:"content-text"},Be={class:"card-header"},Ee={key:0},Ye={class:"user-info"},Pe={class:"user-details"},Ue={class:"user-email"},He={class:"card-header"},je={key:0,class:"attachment-list"},Ne={class:"attachment-info"},Ie={class:"attachment-name"},Le={class:"attachment-meta"},Ge={class:"attachment-actions"},Oe={class:"card-header"},Re={key:0,class:"minutes-content"},Je=["innerHTML"],Ke={class:"user-option"},qe={class:"user-email"},Qe={class:"dialog-footer"},We={class:"minutes-editor"},Xe={class:"dialog-footer"},Ze={class:"dialog-footer"};function $e(h,t,p,e,x,A){const s=c("el-button"),B=c("arrow-down"),T=c("el-icon"),N=c("el-dropdown-item"),O=c("el-dropdown-menu"),R=c("el-dropdown"),S=c("el-empty"),E=c("el-tag"),Y=c("el-avatar"),f=c("el-descriptions-item"),J=c("router-link"),K=c("el-descriptions"),C=c("el-card"),k=c("el-table-column"),b=c("el-table"),I=c("el-upload"),P=c("document"),M=c("el-option"),L=c("el-select"),G=c("el-form-item"),q=c("el-form"),U=c("el-dialog"),Q=c("el-input"),W=we("loading");return ge((m(),y("div",Me,[i("div",Ce,[i("h2",null,d(e.meeting.title||"会议详情"),1),i("div",null,[o(s,{onClick:t[0]||(t[0]=a=>h.$router.back())},{default:n(()=>t[11]||(t[11]=[r("返回")])),_:1}),e.canEdit?(m(),g(s,{key:0,type:"primary",onClick:e.editMeeting},{default:n(()=>t[12]||(t[12]=[r("编辑")])),_:1},8,["onClick"])):w("",!0),e.canEdit?(m(),g(R,{key:1,trigger:"click",onCommand:e.handleCommand},{dropdown:n(()=>[o(O,null,{default:n(()=>[o(N,{command:"duplicate"},{default:n(()=>t[14]||(t[14]=[r("复制会议")])),_:1}),o(N,{command:"delete",divided:""},{default:n(()=>t[15]||(t[15]=[r("删除会议")])),_:1})]),_:1})]),default:n(()=>[o(s,{type:"primary",plain:""},{default:n(()=>[t[13]||(t[13]=i("span",null,"更多操作",-1)),o(T,{class:"el-icon--right"},{default:n(()=>[o(B)]),_:1})]),_:1})]),_:1},8,["onCommand"])):w("",!0)])]),e.notFound?(m(),g(S,{key:0,description:"会议不存在或已被删除"},{default:n(()=>[o(s,{type:"primary",onClick:t[1]||(t[1]=a=>h.$router.push("/meetings"))},{default:n(()=>t[16]||(t[16]=[r("返回会议列表")])),_:1})]),_:1})):e.loading?w("",!0):(m(),y("div",De,[o(C,{class:"detail-card"},{header:n(()=>[i("div",Ve,[t[17]||(t[17]=i("span",null,"基本信息",-1)),o(E,{type:e.statusType,effect:"plain"},{default:n(()=>[r(d(e.statusText),1)]),_:1},8,["type"])])]),default:n(()=>[o(K,{column:2,border:""},{default:n(()=>[o(f,{label:"创建者"},{default:n(()=>{var a,D;return[i("div",xe,[o(Y,{size:24,src:(a=e.meeting.creator)==null?void 0:a.avatar},{default:n(()=>{var F,z;return[r(d((z=(F=e.meeting.creator)==null?void 0:F.name)==null?void 0:z.substring(0,1)),1)]}),_:1},8,["src"]),i("span",null,d((D=e.meeting.creator)==null?void 0:D.name),1)])]}),_:1}),o(f,{label:"关联项目"},{default:n(()=>[e.meeting.project?(m(),g(J,{key:0,to:`/projects/${e.meeting.project.id}`,class:"project-link"},{default:n(()=>[r(d(e.meeting.project.name),1)]),_:1},8,["to"])):(m(),y("span",Te,"无"))]),_:1}),o(f,{label:"开始时间"},{default:n(()=>[r(d(e.formatDateTime(e.meeting.start_time)),1)]),_:1}),o(f,{label:"结束时间"},{default:n(()=>[r(d(e.formatDateTime(e.meeting.end_time)),1)]),_:1}),o(f,{label:"会议地点"},{default:n(()=>[r(d(e.meeting.location),1)]),_:1}),o(f,{label:"创建时间"},{default:n(()=>[r(d(e.formatDateTime(e.meeting.created_at)),1)]),_:1})]),_:1})]),_:1}),o(C,{class:"detail-card"},{header:n(()=>t[18]||(t[18]=[i("div",{class:"card-header"},[i("span",null,"会议内容")],-1)])),default:n(()=>[i("div",Se,[t[19]||(t[19]=i("h4",null,"会议议程",-1)),i("div",Fe,d(e.meeting.agenda||"无"),1)]),e.meeting.notes?(m(),y("div",ze,[t[20]||(t[20]=i("h4",null,"会议备注",-1)),i("div",Ae,d(e.meeting.notes),1)])):w("",!0)]),_:1}),o(C,{class:"detail-card"},{header:n(()=>{var a;return[i("div",Be,[i("span",null,"参会人员 ("+d(((a=e.meeting.participants)==null?void 0:a.length)||0)+")",1),e.canEdit?(m(),g(s,{key:0,type:"primary",plain:"",size:"small",onClick:e.showAddParticipant},{default:n(()=>t[21]||(t[21]=[r(" 添加参会人员 ")])),_:1},8,["onClick"])):w("",!0)])]}),default:n(()=>[e.meeting.participants&&e.meeting.participants.length>0?(m(),y("div",Ee,[o(b,{data:e.meeting.participants,style:{width:"100%"}},{default:n(()=>[o(k,{label:"用户"},{default:n(a=>[i("div",Ye,[o(Y,{size:30,src:a.row.user.avatar},{default:n(()=>[r(d(a.row.user.name.substring(0,1)),1)]),_:2},1032,["src"]),i("div",Pe,[i("div",null,d(a.row.user.name),1),i("div",Ue,d(a.row.user.email),1)])])]),_:1}),o(k,{prop:"role",label:"角色",width:"120"},{default:n(a=>[o(E,{size:"small",effect:"plain"},{default:n(()=>[r(d(a.row.role),1)]),_:2},1024)]),_:1}),o(k,{prop:"status",label:"状态",width:"120"},{default:n(a=>[o(E,{type:e.getParticipantStatusType(a.row.status),size:"small"},{default:n(()=>[r(d(e.getParticipantStatusText(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),e.canEdit?(m(),g(k,{key:0,label:"操作",width:"150"},{default:n(a=>[o(s,{type:"danger",size:"small",plain:"",onClick:D=>e.removeParticipant(a.row)},{default:n(()=>t[22]||(t[22]=[r(" 移除 ")])),_:2},1032,["onClick"])]),_:1})):w("",!0)]),_:1},8,["data"])])):(m(),g(S,{key:1,description:"暂无参会人员"}))]),_:1}),o(C,{class:"detail-card"},{header:n(()=>{var a;return[i("div",He,[i("span",null,"会议附件 ("+d(((a=e.meeting.attachments)==null?void 0:a.length)||0)+")",1),e.canEdit?(m(),g(I,{key:0,class:"upload-attachment",action:`/api/v1/meetings/${e.meetingId}/attachments`,headers:e.uploadHeaders,"on-success":e.handleAttachmentSuccess,"on-error":e.handleAttachmentError,"show-file-list":!1},{default:n(()=>[o(s,{type:"primary",plain:"",size:"small"},{default:n(()=>t[23]||(t[23]=[r("上传附件")])),_:1})]),_:1},8,["action","headers","on-success","on-error"])):w("",!0)])]}),default:n(()=>[e.meeting.attachments&&e.meeting.attachments.length>0?(m(),y("div",je,[(m(!0),y(se,null,re(e.meeting.attachments,a=>(m(),y("div",{key:a.id,class:"attachment-item"},[o(T,null,{default:n(()=>[o(P)]),_:1}),i("div",Ne,[i("div",Ie,d(a.name),1),i("div",Le,[i("span",null,d(e.formatFileSize(a.size)),1),i("span",null,d(e.formatDateTime(a.created_at)),1)])]),i("div",Ge,[o(s,{type:"primary",size:"small",plain:"",onClick:D=>e.downloadAttachment(a)},{default:n(()=>t[24]||(t[24]=[r(" 下载 ")])),_:2},1032,["onClick"]),e.canEdit?(m(),g(s,{key:0,type:"danger",size:"small",plain:"",onClick:D=>e.removeAttachment(a)},{default:n(()=>t[25]||(t[25]=[r(" 删除 ")])),_:2},1032,["onClick"])):w("",!0)])]))),128))])):(m(),g(S,{key:1,description:"暂无会议附件"}))]),_:1}),o(C,{class:"detail-card"},{header:n(()=>[i("div",Oe,[t[26]||(t[26]=i("span",null,"会议纪要",-1)),e.canEdit?(m(),g(s,{key:0,type:"primary",plain:"",size:"small",onClick:e.editMinutes},{default:n(()=>[r(d(e.meeting.minutes?"编辑":"添加")+"会议纪要 ",1)]),_:1},8,["onClick"])):w("",!0)])]),default:n(()=>[e.meeting.minutes?(m(),y("div",Re,[i("div",{innerHTML:e.meeting.minutes},null,8,Je)])):(m(),g(S,{key:1,description:"暂无会议纪要"}))]),_:1})])),o(U,{title:"添加参会人员",modelValue:e.participantDialogVisible,"onUpdate:modelValue":t[5]||(t[5]=a=>e.participantDialogVisible=a),width:"500px"},{footer:n(()=>[i("span",Qe,[o(s,{onClick:t[4]||(t[4]=a=>e.participantDialogVisible=!1)},{default:n(()=>t[27]||(t[27]=[r("取消")])),_:1}),o(s,{type:"primary",onClick:e.addParticipant,loading:e.addingParticipant},{default:n(()=>t[28]||(t[28]=[r(" 确认添加 ")])),_:1},8,["onClick","loading"])])]),default:n(()=>[o(q,{model:e.participantForm,"label-width":"80px"},{default:n(()=>[o(G,{label:"用户"},{default:n(()=>[o(L,{modelValue:e.participantForm.user_id,"onUpdate:modelValue":t[2]||(t[2]=a=>e.participantForm.user_id=a),filterable:"",remote:"","remote-method":e.searchUsers,placeholder:"搜索用户",style:{width:"100%"},loading:e.searchingUsers},{default:n(()=>[(m(!0),y(se,null,re(e.userOptions,a=>(m(),g(M,{key:a.id,label:a.name,value:a.id},{default:n(()=>[i("div",Ke,[o(Y,{size:24,src:a.avatar},{default:n(()=>[r(d(a.name.substring(0,1)),1)]),_:2},1032,["src"]),i("span",null,d(a.name),1),i("span",qe,d(a.email),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","remote-method","loading"])]),_:1}),o(G,{label:"角色"},{default:n(()=>[o(L,{modelValue:e.participantForm.role,"onUpdate:modelValue":t[3]||(t[3]=a=>e.participantForm.role=a),placeholder:"选择角色",style:{width:"100%"}},{default:n(()=>[o(M,{label:"参会者",value:"参会者"}),o(M,{label:"主持人",value:"主持人"}),o(M,{label:"记录员",value:"记录员"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(U,{title:e.meeting.minutes?"编辑会议纪要":"添加会议纪要",modelValue:e.minutesDialogVisible,"onUpdate:modelValue":t[8]||(t[8]=a=>e.minutesDialogVisible=a),width:"800px"},{footer:n(()=>[i("span",Xe,[o(s,{onClick:t[7]||(t[7]=a=>e.minutesDialogVisible=!1)},{default:n(()=>t[29]||(t[29]=[r("取消")])),_:1}),o(s,{type:"primary",onClick:e.saveMinutes,loading:e.savingMinutes},{default:n(()=>t[30]||(t[30]=[r(" 保存 ")])),_:1},8,["onClick","loading"])])]),default:n(()=>[i("div",We,[o(Q,{modelValue:e.minutesForm.content,"onUpdate:modelValue":t[6]||(t[6]=a=>e.minutesForm.content=a),type:"textarea",rows:15,placeholder:"请输入会议纪要内容..."},null,8,["modelValue"])])]),_:1},8,["title","modelValue"]),o(U,{title:"确认删除",modelValue:e.deleteConfirmVisible,"onUpdate:modelValue":t[10]||(t[10]=a=>e.deleteConfirmVisible=a),width:"400px"},{footer:n(()=>[i("span",Ze,[o(s,{onClick:t[9]||(t[9]=a=>e.deleteConfirmVisible=!1)},{default:n(()=>t[31]||(t[31]=[r("取消")])),_:1}),o(s,{type:"danger",onClick:e.confirmDelete,loading:e.deleting},{default:n(()=>t[32]||(t[32]=[r(" 确认删除 ")])),_:1},8,["onClick","loading"])])]),default:n(()=>[i("div",null,'确定要删除会议 "'+d(e.meeting.title)+'" 吗？此操作不可撤销。',1)]),_:1},8,["modelValue"])])),[[W,e.loading]])}const nt=ue(be,[["render",$e],["__scopeId","data-v-096eeeda"]]);export{nt as default};
