import{_ as z,y as m,C as O,j,z as I,D as J,c as G,b as x,d as t,w as o,g as k,x as H,i as L,a as T,B as D,E as y,r,G as K,o as V,e as w,H as P}from"./index-9a8ac2de.js";import{F as Q}from"./FileUpload-c7558ec6.js";const W={class:"achievement-edit"},X={class:"page-header"},Z={__name:"AchievementEdit",setup(ee){const v=L(),R=T(),c=m(null),h=m(null),_=m(!1),E=m(!1),e=O({title:"",achievement_type:"",authors:"",publish_date:"",description:"",url:"",file_path:"",original_file_name:"",files:[]}),C=m(null),g=m(null),F=m(!1);j(()=>F.value?null:g.value?g.value:e.file_path?{original_name:e.original_file_name||"附件",file_path:e.file_path}:null);const N={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:2,max:100,message:"长度在 2 到 100 个字符",trigger:"blur"}],achievement_type:[{required:!0,message:"请选择成果类型",trigger:"change"}],authors:[{required:!0,message:"请输入作者",trigger:"blur"}],publish_date:[{required:!0,message:"请选择发布日期",trigger:"change"}],description:[{required:!0,message:"请输入描述",trigger:"blur"}],url:[{pattern:/^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([\/\w .-]*)*\/?$/,message:"请输入有效的URL",trigger:"blur"}]},U=async()=>{_.value=!0;try{const i=await D.get(`/api/v1/achievements/${v.params.id}`);e.title=i.data.title,e.achievement_type=i.data.achievement_type,e.authors=i.data.authors,e.publish_date=i.data.publish_date,e.description=i.data.description,e.url=i.data.url,e.file_path=i.data.file_path,e.original_file_name=i.data.original_file_name,e.files=i.data.files||[],C.value=JSON.parse(JSON.stringify(i.data))}catch(i){console.error("获取成果详情失败:",i),y.error("获取成果详情失败")}finally{_.value=!1}},$=i=>{e.files.push(i)},q=()=>{g.value=null,F.value=!0},B=async()=>{c.value&&await c.value.validate(async i=>{var l,f,p,n,u;if(i){_.value=!0;try{const a={title:e.title,achievement_type:e.achievement_type,authors:e.authors,publish_date:e.publish_date,description:e.description,url:e.url};e.files.length>0?(a.file_path=e.files[0].file_path,a.original_file_name=e.files[0].original_name,e.files.length>1&&(a.additional_files=e.files.slice(1))):e.file_path&&(a.file_path=e.file_path,a.original_file_name=e.original_file_name),console.log("提交数据:",a),Object.keys(a).forEach(d=>{d!=="additional_files"&&a[d]!==null&&a[d]!==void 0&&typeof a[d]!="string"&&(a[d]=String(a[d]))}),console.log("处理后的提交数据:",a);const b=await D.put(`/api/v1/achievements/${v.params.id}`,a);console.log("成功响应:",b.data),y.success("成果更新成功"),R.push(`/achievements/${v.params.id}`)}catch(a){console.error("更新成果失败:",a),console.error("错误详情:",(l=a.response)==null?void 0:l.data),y.error(((p=(f=a.response)==null?void 0:f.data)==null?void 0:p.message)||((u=(n=a.response)==null?void 0:n.data)==null?void 0:u.msg)||"更新成果失败")}finally{_.value=!1}}})},M=()=>{c.value&&(c.value.resetFields(),h.value&&h.value.clearFiles(),e.files=[],U())};return I(()=>{U()}),(i,l)=>{const f=r("el-button"),p=r("el-input"),n=r("el-form-item"),u=r("el-option"),a=r("el-select"),b=r("el-date-picker"),d=r("el-form"),A=r("el-card"),S=r("el-empty"),Y=K("loading");return J((V(),G("div",W,[x("div",X,[l[8]||(l[8]=x("h2",{class:"page-title"},"编辑成果",-1)),t(f,{onClick:l[0]||(l[0]=s=>i.$router.back())},{default:o(()=>l[7]||(l[7]=[w("返回")])),_:1})]),e?(V(),k(A,{key:0},{default:o(()=>[t(d,{ref_key:"achievementForm",ref:c,model:e,rules:N,"label-width":"100px",onSubmit:P(B,["prevent"])},{default:o(()=>[t(n,{label:"标题",prop:"title"},{default:o(()=>[t(p,{modelValue:e.title,"onUpdate:modelValue":l[1]||(l[1]=s=>e.title=s),placeholder:"请输入成果标题"},null,8,["modelValue"])]),_:1}),t(n,{label:"类型",prop:"achievement_type"},{default:o(()=>[t(a,{modelValue:e.achievement_type,"onUpdate:modelValue":l[2]||(l[2]=s=>e.achievement_type=s),placeholder:"请选择成果类型",style:{width:"100%"}},{default:o(()=>[t(u,{label:"论文",value:"论文"}),t(u,{label:"专利",value:"专利"}),t(u,{label:"项目",value:"项目"}),t(u,{label:"奖项",value:"奖项"}),t(u,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1}),t(n,{label:"作者",prop:"authors"},{default:o(()=>[t(p,{modelValue:e.authors,"onUpdate:modelValue":l[3]||(l[3]=s=>e.authors=s),placeholder:"请输入作者，多个作者用逗号分隔"},null,8,["modelValue"])]),_:1}),t(n,{label:"发布日期",prop:"publish_date"},{default:o(()=>[t(b,{modelValue:e.publish_date,"onUpdate:modelValue":l[4]||(l[4]=s=>e.publish_date=s),type:"date",placeholder:"选择日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(n,{label:"描述",prop:"description"},{default:o(()=>[t(p,{modelValue:e.description,"onUpdate:modelValue":l[5]||(l[5]=s=>e.description=s),type:"textarea",rows:5,placeholder:"请输入成果描述"},null,8,["modelValue"])]),_:1}),t(n,{label:"相关链接",prop:"url"},{default:o(()=>[t(p,{modelValue:e.url,"onUpdate:modelValue":l[6]||(l[6]=s=>e.url=s),placeholder:"请输入相关链接（可选）"},null,8,["modelValue"])]),_:1}),t(n,{label:"附件",prop:"files"},{default:o(()=>[t(Q,{ref_key:"fileUploadRef",ref:h,"initial-files":e.files,onFileUploaded:$,onFileRemoved:q},null,8,["initial-files"])]),_:1}),t(n,null,{default:o(()=>[t(f,{type:"primary","native-type":"submit",loading:E.value},{default:o(()=>l[9]||(l[9]=[w("保存")])),_:1},8,["loading"]),t(f,{onClick:M},{default:o(()=>l[10]||(l[10]=[w("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1})):_.value?H("",!0):(V(),k(S,{key:1,description:"成果不存在或已被删除"}))])),[[Y,_.value]])}}},ae=z(Z,[["__scopeId","data-v-285341df"]]);export{ae as default};
